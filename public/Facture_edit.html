
<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>SDSA - FE</title>
	<link rel="stylesheet" href="styles.css"> <!-- Fichier CSS commun -->
</head>
<body>
	<div class="header">
		<div class="logo">
			<img src="logo_complet_SD_2.jpg" alt="Logo" width="100" height="100">
		</div>
		<div class="title">
			<h2>Facture</h2>
		</div>
    </div>
	<div class="container-wrapper">
		<div class="container">
			<br /><b>Liste des dossiers en cours</b>
			<div id="dropdown-containers"></div><br />
			<div class="en_ligne">
				<div class="container">
					<b>N° facture</b>
					<input type="text" id="no_facture" class="input-field" style="width: 80%"></input>
				</div>
				<div class="container">
					<b>Date facture</b>
					<input type="date" id="date_facture" class="date-field" style="width: 80%"></input>
				</div>
				<div class="container">
					<b>Date règlement</b>
					<input type="date" id="annee_facture" class="input-field" style="width: 80%"></input>
				</div>
			</div>
			<div class="en_ligne">
				<div class="container">
					<b>DES</b>
					<input type="text" id="des" class="input-field" style="width: 80%"></input>
				</div>
				<div class="container">
					<b>DES date maxi</b>
					<input type="date" id="des_max_date" class="date-field" style="width: 80%"></input>
				</div>
				<div class="container">
					<b>DES date</b>
					<input type="date" id="des_date" class="date-field" style="width: 80%"></input>
				</div>
			</div>
			<br /><b>Ref facture</b>
			<textarea type="text" id="ref_fact" class="input-field" style="font-family: Calibri;width: 95%;height: 100%"></textarea>
			<br /><b>Commentaire</b>
			<textarea type="text" id="comment" class="input-field" style="font-family: Calibri;width: 95%;height: 100%"></textarea>
		</div>		
		<div class="container">
			<p><b>Détail Proposition de service</b></p>
			<textarea type="text" id="detail_ps" class="input-field" style="font-family: Calibri;width: 95%;height: 80%"></textarea>
		</div>
		<div class="container">
			<div class="en_ligne">
			<!form id="form" method="POST" action="/dossier_save">
				<div class="container">
					<b>Montant HT</b>
					<input type="text" id="montant_ht" class="input-field" style="width: 100px"></input>
				</div>
				<div class="container">
					<b>Montant TVA</b>
					<input type="text" id="montant_tva" class="input-field" style="width: 100px"></input>
				</div>
				<div class="container">
					<b>Montant TTC</b>
					<input type="text" id="montant_ttc" class="input-field" style="width: 100px"></input>
				</div>
			</div>	
				<br />
				<b>Chemin Facture</b>
				<input type="text" id="livrable" class="input-field" style="width: 95%"></input> 
				<div id="message_html"></div>
				<button id="creer_fact" type="submit" class="button" >Initier facture</button>
				<button id="update_detail_ps" type="submit" class="button" >MàJ détail PS</button>
			<!/form>
			
		</div>
			<div id="message_html"></div>
		
	</div>
	<a href="Actions.html"><button id="myExit" type="button" class="exit_button">Revenir aux actions</button></a>
	
	<script>
		var id_dossier='';
		
		// Requête AJAX pour récupérer les options des listes déroulantes
        fetch('/getDossiers')
            .then(response => response.text())
            .then(data => {
                document.getElementById('dropdown-containers').innerHTML = data;
            })
            .catch(error => console.error('Error fetching options:', error));

		//document.getElementById('montant_ht').addEventListener('change', () => {		
		//	event.preventDefault();
		//	int montant_ht=document.getElementById('montant_ht').value;
		//	int montant_tva=montant_ht*0.2;
		//	int montant_ttc=montant_ht+montant_tva;
		//	document.getElementById('montant_tva').value=montant_tva;
		//	document.getElementById('montant_ttc').value=montant_ttc;
		//});
		
		document.getElementById('dropdown-containers').addEventListener('change', () => {
			event.preventDefault();
			id_dossier = document.querySelector('#dropdown-containers select').value;
 			
			//console.log("dossier=",selected_dos);
            fetch('/prepa_fact', {
                method: 'POST',
				headers: {
                    'Content-Type': 'application/json'
                },
				body: JSON.stringify({
                    id_dossier: id_dossier,
               })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
				const {nom,detail_ps,montant_ht}=data;

				document.getElementById('detail_ps').value=detail_ps;
				document.getElementById('montant_ht').value=montant_ht;
				document.getElementById('message_html').value=null;
				let montant_tva=montant_ht*0.2;
				let montant_ttc=montant_ht+montant_tva;
				document.getElementById('montant_tva').value=montant_tva;
				document.getElementById('montant_ttc').value=montant_ttc;
            })
            .catch(error => console.error('Error:', error));
			
			fetch('/get_max_num_fact')
				.then(response => response.json())
				.then(data => {
					const {max_num_fact}=data;
					const num_fact_str=max_num_fact.toString()
					var num_fact_base=num_fact_str.substring(0,6);
					
					const aujourdHui = new Date();// Créer un nouvel objet Date pour obtenir la date du jour
					const annee = aujourdHui.getFullYear();// Extraire l'année
					let mois = aujourdHui.getMonth() + 1;// Extraire le mois (les mois sont indexés à partir de 0, donc ajouter 1)
					mois=(mois < 10 ? '0' : '')+mois //ajouter 0 pour les mois <10

					if((annee+mois)===num_fact_base) {
						var index=num_fact_str.substring(6,9);
						let num=parseInt(index, 10)+1;
						index = num.toString().padStart(3, '0');
					}else {
						var index="001";
					}
					
					document.getElementById('no_facture').value=annee+mois+index;
				})
				.catch(error => console.error('Error:', error));
        });
		
		document.getElementById('creer_fact').addEventListener('click', () => {
			event.preventDefault();
			const detail_ps=document.getElementById('detail_ps').value;
			const montant_ht=document.getElementById('montant_ht').value;
			
			fetch('/facture_create', {
                method: 'POST',
				headers: {
                    'Content-Type': 'application/json'
                },
				body: JSON.stringify({
                    dossier: selected_dos,
					nom: nom,
					detail_ps: detail_ps,
					date_ps: date_ps,
					date_ok: date_ok,
					date_livrable: date_livrable,
					chemin_ps: chemin_ps,
					chemin_livrable: chemin_livrable,
					montant_ht: montant_ht
               })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
			})
            .catch(error => console.error('Error:', error));
        });

		document.getElementById('update_detail_ps').addEventListener('click', () => {
			event.preventDefault();
			const detail_ps=document.getElementById('detail_ps').value;
			
			fetch('/update_detail_ps', {
                method: 'POST',
				headers: {
                    'Content-Type': 'application/json'
                },
				body: JSON.stringify({
                    id_dossier: id_dossier,
					detail_ps: detail_ps,
               })
            })
            .then(response => response.json())
            .then(data => {
                console.log(data);
			})
            .catch(error => console.error('Error:', error));
        });

		
   </script>
	<script src="https://cdn.socket.io/4.8.1/socket.io.min.js"></script>
    <script>
        const socket = io();

        socket.on('console_message', (message) => {
            const messageContainer = document.getElementById('message_html');
			messageContainer.innerHTML = message;
        });
    </script>

</body>
</html>


